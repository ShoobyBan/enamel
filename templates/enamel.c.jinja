/**
 * This file was generated with Enamel : http://gregoiresage.github.io/enamel
 */

#include <pebble.h>
#include <pebble-events/pebble-events.h>
#include "enamel.h"

#ifndef ENAMEL_MAX_STRING_LENGTH
#define ENAMEL_MAX_STRING_LENGTH 30
#endif

static EventHandle event_handle;
static EnamelSettingsReceivedCallback *settings_received_callback; 


typedef struct {
  uint8_t size;
  uint32_t* hash;
} persist_keys;

static persist_keys pkeys;


static int get_pkey(persist_keys keys_, uint32_t hash_){
	for(uint8_t i=0; i<size; i++){
		if(keys_.hash[i] == hash_)
			return i;
	}
	return 0xFFFF;
}

{% macro item_accessors_code(item) %}
{% if 'messageKey' in item and 'enamel-ignore' not in item %}
{% if 'capabilities' in item %}
#if {{ item['capabilities']|getdefines }}
{% endif %}
// -----------------------------------------------------
// Getter for '{{ item|getid }}'
#define {{ item|getid|cvarname|upper }}_PKEY {{ package['pebble']['messageKeys'][item['messageKey']] }}
{% if item['type'] == 'toggle' %}
static bool _{{ item|getid|cvarname }};
bool enamel_get_{{ item|getid|cvarname }}(){
	return _{{ item|getid|cvarname }};
}
static void set_{{ item|getid|cvarname }}(bool value){
	_{{ item|getid|cvarname }} = value;
}
{% elif item['type'] == 'select' or item['type'] == 'radiogroup' %}
{% if item['options'][0]['value'] is string %}
static uint16_t _{{ item|getid|cvarname }};
static const char* {{ item|getid|cvarname }}_values[] = {
{%- for option in item['options'] -%}
	"{{ option['value'] }}",
{%- endfor -%}
};
const char* enamel_get_{{ item|getid|cvarname }}(){
	return {{ item|getid|cvarname }}_values[_{{ item|getid|cvarname }}];
}
static void set_{{ item|getid|cvarname }}(char* value){
	for(uint16_t i=0; i<{{ item['options']|length }}; i++){
		if(strcmp(value, {{ item|getid|cvarname }}_values[i]) == 0){
			_{{ item|getid|cvarname }} = i;
			return;
		}
	}
	_{{ item|getid|cvarname }} = 0;
}
{% else %}
{{ item|getid|cvarname|upper }}Value _{{ item|getid|cvarname }};
{{ item|getid|cvarname|upper }}Value enamel_get_{{ item|getid|cvarname }}(){
	return _{{ item|getid|cvarname }};
}
static void set_{{ item|getid|cvarname }}({{ item|getid|cvarname|upper }}Value value){
	_{{ item|getid|cvarname }} = value;
}
{% endif %}
{% elif item['type'] == 'input' %}
static char* _{{ item|getid|cvarname }}; 
const char* enamel_get_{{ item|getid|cvarname }}(){
	return _{{ item|getid|cvarname }};
}
static void set_{{ item|getid|cvarname }}(char* value){
	if(_{{ item|getid|cvarname }}) free( _{{ item|getid|cvarname }});
	uint32_t size = strlen(value);
	_{{ item|getid|cvarname }} = malloc(size + 1);
	_{{ item|getid|cvarname }}[size] = 0;
	strncpy(_{{ item|getid|cvarname }}, value, size);
}
{% elif item['type'] == 'color' %}
static GColor _{{ item|getid|cvarname }};
GColor enamel_get_{{ item|getid|cvarname }}(){
	return _{{ item|getid|cvarname }};
}
static void set_{{ item|getid|cvarname }}(uint8_t value){
	_{{ item|getid|cvarname }}.argb = value;
}
{% elif item['type'] == 'slider' %}
static int32_t _{{ item|getid|cvarname }};
int32_t enamel_get_{{ item|getid|cvarname }}(){
	return _{{ item|getid|cvarname }};
}
static void set_{{ item|getid|cvarname }}(int32_t value){
	_{{ item|getid|cvarname }} = value;
}
{% elif item['type'] == 'checkboxgroup' %}
static bool _{{ item|getid|cvarname }}[{{item['options']|length}}];
bool enamel_get_{{ item|getid|cvarname }}({{ item|getid|cvarname|upper }}Value index_){
	return _{{ item|getid|cvarname }}[index_];
}
static void set_{{ item|getid|cvarname }}({{ item|getid|cvarname|upper }}Value index_, bool data_){
	_{{ item|getid|cvarname }}[index_] = data_;
}
{% endif %}
// -----------------------------------------------------
{% if 'capabilities' in item %}
#endif
{% endif %}

{% endif %}
{%- endmacro -%}

{% for item in config -%}
{% if item['type'] == 'section' %}
{% for item in item['items'] %}
{{ item_accessors_code(item) }}
{%- endfor %}
{% else %}
{{ item_accessors_code(item) }}
{%- endif %}
{% endfor %}

{% macro item_in_received_handler(item) %}
{% if 'messageKey' in item and 'enamel-ignore' not in item %}
{% if 'capabilities' in item %}
#if {{ item['capabilities']|getdefines }}
{% endif %}
	tuple = dict_find(iter, {{ item|getmessagekey }});
	changed = changed || (tuple != NULL);
	{% if item['type'] == 'input' %}
	tuple ? set_{{ item|getid|cvarname }}(tuple->value->cstring) : false;
	{% elif item['type'] == 'select' or item['type'] == 'radiogroup' %}
	{% if item['options'][0]['value'] is string %}
	tuple ? set_{{ item|getid|cvarname }}(tuple->value->cstring) : false;
	{% else %}
	tuple ? set_{{ item|getid|cvarname }}(atoi(tuple->value->cstring)) : false;
	{% endif %}
	{% elif item['type'] == 'color' %}
	tuple ? set_{{ item|getid|cvarname }}(GColorFromHEX(tuple->value->int32).argb) : false;
	{% elif item['type'] == 'toggle' %}
	tuple ? set_{{ item|getid|cvarname }}(tuple->value->int32) : false;
	{% elif item['type'] == 'slider' %}
	tuple ? set_{{ item|getid|cvarname }}(tuple->value->int32) : false;
	{% elif item['type'] == 'checkboxgroup' %}
	{% for option in item['options'] %}
	tuple = dict_find(iter,  {{ item|getmessagekey }} + {{ loop.index0 }});
	changed = changed || (tuple != NULL);
	tuple ? set_{{ item|getid|cvarname }}({{ loop.index0 }}, tuple->value->int32 == 1) : false;
	{% endfor %}
	{% endif %}
{% if 'capabilities' in item %}
#endif
{% endif %}
{% endif %}
{% endmacro -%}

{% macro item_init(item) %}
{% if 'messageKey' in item and 'enamel-ignore' not in item %}
{% if 'capabilities' in item %}
#if {{ item['capabilities']|getdefines }}
{% endif %}
	if (persist_exists({{ item|getid|cvarname|upper }}_PKEY)) {
		{% if item['type'] == 'input' %}
		char tmp[ENAMEL_MAX_STRING_LENGTH];
		memset(tmp, 0, ENAMEL_MAX_STRING_LENGTH);
		persist_read_string({{ item|getid|cvarname|upper }}_PKEY, tmp, ENAMEL_MAX_STRING_LENGTH);
		set_{{ item|getid|cvarname }}(tmp);
		{% elif item['type'] == 'select' or item['type'] == 'radiogroup' %}
		{% if item['options'][0]['value'] is string %}
		_{{ item|getid|cvarname }} = (uint16_t)persist_read_int({{ item|getid|cvarname|upper }}_PKEY);
		{% else %}
		set_{{ item|getid|cvarname }}(persist_read_int({{ item|getid|cvarname|upper }}_PKEY));
		{% endif %}
		{% elif item['type'] == 'color' %}
		set_{{ item|getid|cvarname }}(persist_read_int({{ item|getid|cvarname|upper }}_PKEY));
		{% elif item['type'] == 'slider' %}
		set_{{ item|getid|cvarname }}(persist_read_int({{ item|getid|cvarname|upper }}_PKEY));
		{% elif item['type'] == 'toggle' %}
		set_{{ item|getid|cvarname }}(persist_read_bool({{ item|getid|cvarname|upper }}_PKEY));
		{% elif item['type'] == 'checkboxgroup' %}
		persist_read_data({{ item|getid|cvarname|upper }}_PKEY, _{{ item|getid|cvarname }}, {{ item['options']|length }});
		{% endif %}
	}
	{% if 'defaultValue' in item %}
	else {
		{% if item['type'] == 'input' %}
		set_{{ item|getid|cvarname }}("{{item['defaultValue']}}");
		{% elif item['type'] == 'select' or item['type'] == 'radiogroup' %}
		{% if item['options'][0]['value'] is string %}
		set_{{ item|getid|cvarname }}("{{item['defaultValue']}}");
		{% else %}
		set_{{ item|getid|cvarname }}({{item['defaultValue']}});
		{% endif %}
		{% elif item['type'] == 'color' %}
		{% if item['defaultValue'] is string %}
		set_{{ item|getid|cvarname }}(GColorFromHEX(0x{{item['defaultValue']}}).argb);
		{% else %}
		set_{{ item|getid|cvarname }}(GColorFromHEX({{item['defaultValue']}}).argb);
		{% endif %}
		{% elif item['type'] == 'slider' %}
		{% if 'step' in item and '.' in item['step']|string %}
		set_{{ item|getid|cvarname }}({{ (item['defaultValue'] * 10**((item['step'] - item['step']|round(0, 'floor'))|string|length - 2))|int }});
		{% else %}
		set_{{ item|getid|cvarname }}({{item['defaultValue']|lower}});
		{% endif %}
		{% elif item['type'] == 'toggle' %}
		set_{{ item|getid|cvarname }}({{item['defaultValue']|lower}});
		{% elif item['type'] == 'checkboxgroup' %}
		{% for val in item['defaultValue'] %}
		set_favorite_food({{ loop.index0 }}, {{ val|lower }});
		{% endfor %}
		{% endif %}
	}
	{% endif %}
{% if 'capabilities' in item %}
#endif
{% endif %}
{% endif %}
{% endmacro -%}

{% macro item_dict_size(item) %}
{% if 'messageKey' in item and 'enamel-ignore' not in item %}
{% if item['type'] == 'input' %}
+ 7 + ENAMEL_MAX_STRING_LENGTH
{% elif item['type'] == 'select' or item['type'] == 'radiogroup' %}
+ 7 + {{ item|maxdictsize }}
{% elif item['type'] == 'checkboxgroup' %}
+ 7 + {{ item['options']|length }}
{% elif item['type'] == 'color' or item['type'] == 'toggle' or item['type'] == 'slider' %}
+ 7 + 4
{% endif %}
{% endif %}
{% endmacro -%}

static uint16_t enamel_get_inbound_size() {
	return 1
		{% for item in config %}
		{% if item['type'] == 'section' %}
{%- if 'capabilities' in item %}
#if {{ item['capabilities']|getdefines }}
{% endif -%}
		{% for item in item['items'] %}
{%- if 'capabilities' in item %}
#if {{ item['capabilities']|getdefines }}
{% endif -%}
			{{ item_dict_size(item) }}
{%- if 'capabilities' in item %}
#endif
{% endif -%}
		{%- endfor %}
{%- if 'capabilities' in item %}
#endif
{% endif -%}
		{% else %}
{%- if 'capabilities' in item %}
#if {{ item['capabilities']|getdefines }}
{% endif -%}
			{{ item_dict_size(item) }}
{%- if 'capabilities' in item %}
#endif
{% endif -%}
		{%- endif %}
		{% endfor %};
}

static void inbox_received_handle(DictionaryIterator *iter, void *context) {
	Tuple *tuple = NULL;
	bool changed = false;
{% for item in config %}
{% if item['type'] == 'section' %}
{% for item in item['items'] %}
{{ item_in_received_handler(item) }}
{%- endfor %}
{% else %}
{{ item_in_received_handler(item) }}
{%- endif %}
{% endfor %}

	if(changed && settings_received_callback){
		settings_received_callback();
	}
}

void enamel_init(){
{% for item in config %}
{% if item['type'] == 'section' %}
{% for item in item['items'] %}
{{ item_init(item) }}
{%- endfor %}
{% else %}
{{ item_init(item) }}
{%- endif %}
{% endfor %}
	
	settings_received_callback = NULL;
	event_handle = events_app_message_register_inbox_received(inbox_received_handle, NULL);
	events_app_message_request_inbox_size(enamel_get_inbound_size());
}

{% macro item_deinit(item) %}
{% if 'messageKey' in item and 'enamel-ignore' not in item %}
{% if 'capabilities' in item %}
#if {{ item['capabilities']|getdefines }}
{% endif %}
	{% if item['type'] == 'input' %}
	persist_write_string({{ item|getid|cvarname|upper }}_PKEY, _{{ item|getid|cvarname }});
	if(_{{ item|getid|cvarname }}) free(_{{ item|getid|cvarname }});
	{% elif item['type'] == 'select' or item['type'] == 'radiogroup' %}
	{% if item['options'][0]['value'] is string %}
	!persist_exists({{ item|getid|cvarname|upper }}_PKEY) || (persist_read_int({{ item|getid|cvarname|upper }}_PKEY) != (int32_t)_{{ item|getid|cvarname }}) ? persist_write_int({{ item|getid|cvarname|upper }}_PKEY, _{{ item|getid|cvarname }}) : false;
	{% else %}
	!persist_exists({{ item|getid|cvarname|upper }}_PKEY) || (persist_read_int({{ item|getid|cvarname|upper }}_PKEY) != _{{ item|getid|cvarname }}) ? persist_write_int({{ item|getid|cvarname|upper }}_PKEY, _{{ item|getid|cvarname }}) : false;
	{% endif %}
	{% elif item['type'] == 'toggle' %}
	!persist_exists({{ item|getid|cvarname|upper }}_PKEY) || (persist_read_bool({{ item|getid|cvarname|upper }}_PKEY) != _{{ item|getid|cvarname }}) ? persist_write_bool({{ item|getid|cvarname|upper }}_PKEY, _{{ item|getid|cvarname }}) : false;
	{% elif item['type'] == 'color' %}
	!persist_exists({{ item|getid|cvarname|upper }}_PKEY) || (persist_read_int({{ item|getid|cvarname|upper }}_PKEY) != _{{ item|getid|cvarname }}.argb) ? persist_write_int({{ item|getid|cvarname|upper }}_PKEY, _{{ item|getid|cvarname }}.argb) : false;
	{% elif item['type'] == 'slider' %}
	!persist_exists({{ item|getid|cvarname|upper }}_PKEY) || (persist_read_int({{ item|getid|cvarname|upper }}_PKEY) != _{{ item|getid|cvarname }}) ? persist_write_int({{ item|getid|cvarname|upper }}_PKEY, _{{ item|getid|cvarname }}) : false;
	{% elif item['type'] == 'checkboxgroup' %}
	persist_write_data({{ item|getid|cvarname|upper }}_PKEY, _{{ item|getid|cvarname }}, {{ item['options']|length }});
	{% endif %}
{% if 'capabilities' in item %}
#endif
{% endif %}
{% endif %}
{% endmacro -%}

void enamel_deinit(){
{% for item in config %}
{% if item['type'] == 'section' %}
{% for item in item['items'] %}
{{ item_deinit(item) }}
{%- endfor %}
{% else %}
{{ item_deinit(item) }}
{%- endif %}
{% endfor %}
	events_app_message_unsubscribe(event_handle);
	settings_received_callback = NULL;
}

void enamel_register_settings_received(EnamelSettingsReceivedCallback *callback){
	settings_received_callback = callback;
}

